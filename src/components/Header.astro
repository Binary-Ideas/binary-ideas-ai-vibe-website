---
import { servicesContent } from "../data/services/content";

interface NavItem {
  label: string;
  href: string;
  fontSize?: string;
}

interface Props {
  logoSrc?: string;
  logoAlt?: string;
  navItems?: NavItem[];
  ctaText?: string;
  ctaLink?: string;
}

const {
  logoSrc = "/img/bi-ai-logo-white-2x-1.png",
  logoAlt = "Bi AI logo white",
  navItems = [
    { label: "AI Consulting", href: "/AI-Consulting", fontSize: "text-base" },
    { label: "AI Audit", href: "/AI-Audit", fontSize: "text-base" },
    { label: "What Are AI Agents?", href: "/what-are-ai-agents", fontSize: "text-base" },
    { label: "Services", href: "#services", fontSize: "text-base" },
    { label: "Blogs", href: "/blog", fontSize: "text-base" },
  ],
  ctaText = "Get Started",
  ctaLink = "https://api.3sixtycrm.com/widget/bookings/robert-sandiego"
} = Astro.props;

const navLinkBaseClass =
  "[font-family:'Segoe_UI_Symbol-Regular',Helvetica] font-normal text-[#d0d5db] tracking-[0] leading-6 hover:text-white transition-colors duration-200";

const serviceNavLabelMap: Record<string, string> = {
  "voice-ai-agents": "Voice AI Agents",
  "chatbot-ai": "Chatbot AI",
  "lead-generation-ai": "Lead Generation AI",
  "social-media-ai": "Social Media AI",
  "training-agents": "Training Agents",
  "email-marketing-ai": "Email Marketing AI"
};

const serviceNavItems = servicesContent.map((service) => {
  const labelSource =
    serviceNavLabelMap[service.meta.slug] ??
    service.meta.title ??
    service.hero?.titleLeading ??
    service.meta.slug.replace(/-/g, " ");

  return {
    label: labelSource.trim(),
    href: `/services/${service.meta.slug}`
  };
});

const hasServiceNavItems = serviceNavItems.length > 0;
---

<header
  data-site-header
  class="fixed top-0 left-0 w-full z-[2] bg-[#0a0a0fcc] border-b border-solid border-[#fffefe1a] backdrop-blur-md backdrop-brightness-[100%] [-webkit-backdrop-filter:blur(12px)_brightness(100%)]"
>
  <div class="max-w-7xl mx-auto px-4 md:px-8">
    <div class="flex w-full items-center justify-between gap-4 py-3 md:py-0 md:h-[97px]">
      <a href="/" class="flex-shrink-0">
        <img
          class="w-[180px] md:w-[216px] h-auto aspect-[4.06] object-cover"
          alt={logoAlt}
          src={logoSrc}
        />
      </a>

      <nav
        data-desktop-nav
        class="hidden md:flex items-center gap-6"
        role="navigation"
        aria-label="Main navigation"
      >
        {navItems.map((item) => {
          if (item.label === "Services") {
            return (
              <div class="relative group">
                <a
                  href={item.href}
                  class={`${navLinkBaseClass} whitespace-nowrap ${item.fontSize || "text-base"}`}
                  aria-haspopup={hasServiceNavItems ? "true" : "false"}
                >
                  {item.label}
                </a>

                {hasServiceNavItems && (
                  <div class="hidden md:absolute md:left-0 md:top-full md:min-w-[220px] md:rounded-xl md:border md:border-[#fffefe1a] md:bg-[#0a0a0fcc] md:pt-5 md:px-3 md:pb-3 md:shadow-[0px_25px_50px_-12px_rgba(0,0,0,0.6)] md:backdrop-blur-md md:backdrop-brightness-[100%] md:group-hover:flex md:group-focus-within:flex md:flex-col md:gap-1 md:z-10">
                    {serviceNavItems.map((service) => (
                      <a
                        href={service.href}
                        class={`${navLinkBaseClass} w-full rounded-md px-4 py-2 text-sm whitespace-nowrap hover:bg-[#ffffff14]`}
                      >
                        {service.label}
                      </a>
                    ))}
                  </div>
                )}
              </div>
            );
          }

          return (
            <a
              href={item.href}
              class={`${navLinkBaseClass} whitespace-nowrap ${item.fontSize || "text-base"}`}
            >
              {item.label}
            </a>
          );
        })}

        <a
          href={ctaLink}
          class="px-6 py-2 rounded-[10px] bg-[linear-gradient(90deg,rgba(43,127,255,1)_0%,rgba(152,16,250,1)_100%)] hover:opacity-90 transition-opacity duration-200"
          target="_blank"
          rel="noopener noreferrer"
        >
          <span class="[font-family:'Segoe_UI_Symbol-Regular',Helvetica] font-normal text-white text-base tracking-[0] leading-6 whitespace-nowrap">
            {ctaText}
          </span>
        </a>
      </nav>

      <button
        type="button"
        class="md:hidden inline-flex h-11 w-11 items-center justify-center rounded-md border border-[#ffffff1f] bg-[#0a0a0f]/70 text-white transition-colors duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-white/40 hover:bg-[#0a0a0f]/90"
        data-menu-toggle
        aria-expanded="false"
        aria-controls="mobile-site-nav"
        data-label-open="Open navigation menu"
        data-label-close="Close navigation menu"
      >
        <span class="sr-only">Open navigation menu</span>
        <svg
          data-menu-icon-open
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="h-6 w-6"
        >
          <line x1="3" y1="6" x2="21" y2="6" />
          <line x1="3" y1="12" x2="21" y2="12" />
          <line x1="3" y1="18" x2="21" y2="18" />
        </svg>
        <svg
          data-menu-icon-close
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="hidden h-6 w-6"
        >
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
    </div>
  </div>

  <div
    id="mobile-site-nav"
    data-mobile-menu
    class="md:hidden hidden border-t border-[#fffefe1a] bg-[#05050a]/95 backdrop-blur-md backdrop-brightness-[100%]"
    aria-hidden="true"
  >
    <div class="max-w-7xl mx-auto px-4 py-6 flex flex-col gap-6">
      <div class="flex flex-col gap-4">
        {navItems.map((item) => {
          const isServices = item.label === "Services";

          if (isServices) {
            return (
              <div class="flex flex-col gap-3">
                <a
                  href={item.href}
                  class={`${navLinkBaseClass} text-lg !text-white`}
                  data-menu-close
                >
                  {item.label}
                </a>
                {hasServiceNavItems && (
                  <div class="flex flex-col gap-2 border-l border-white/10 pl-4">
                    {serviceNavItems.map((service) => (
                      <a
                        href={service.href}
                        class={`${navLinkBaseClass} text-sm !text-[#cbd4e6] hover:!text-white`}
                        data-menu-close
                      >
                        {service.label}
                      </a>
                    ))}
                  </div>
                )}
              </div>
            );
          }

          return (
            <a
              href={item.href}
              class={`${navLinkBaseClass} text-lg !text-white`}
              data-menu-close
            >
              {item.label}
            </a>
          );
        })}
      </div>

      <div class="flex flex-col gap-3">
        <a
          href={ctaLink}
          class="inline-flex w-full items-center justify-center gap-2 rounded-[12px] bg-[linear-gradient(90deg,rgba(43,127,255,1)_0%,rgba(152,16,250,1)_100%)] px-6 py-3 text-base font-semibold text-white transition-opacity duration-200 hover:opacity-90"
          target="_blank"
          rel="noopener noreferrer"
          data-menu-close
        >
          {ctaText}
        </a>
      </div>
    </div>
  </div>
</header>

<script is:inline>
  (() => {
    const header = document.querySelector('[data-site-header]');
    if (!header) return;

    const toggle = header.querySelector('[data-menu-toggle]');
    const menu = header.querySelector('[data-mobile-menu]');
    if (!toggle || !menu) return;

    const openIcon = toggle.querySelector('[data-menu-icon-open]');
    const closeIcon = toggle.querySelector('[data-menu-icon-close]');
    const openLabel = toggle.getAttribute('data-label-open') ?? 'Open navigation menu';
    const closeLabel = toggle.getAttribute('data-label-close') ?? 'Close navigation menu';

    if (!openIcon || !closeIcon) return;

    const root = document.documentElement;
    let isBodyLocked = false;

    const cleanupLocks = () => {
      document.body.classList.remove('overflow-hidden');
      root.classList.remove('overflow-hidden');
      isBodyLocked = false;
    };

    cleanupLocks();

    const setBodyLock = (shouldLock) => {
      if (shouldLock) {
        if (isBodyLocked) return;
        document.body.classList.add('overflow-hidden');
        root.classList.add('overflow-hidden');
        isBodyLocked = true;
      } else {
        cleanupLocks();
      }
    };

    const setMenuState = (isOpen) => {
      toggle.setAttribute('aria-expanded', String(isOpen));
      toggle.setAttribute('aria-label', isOpen ? closeLabel : openLabel);
      menu.classList.toggle('hidden', !isOpen);
      menu.setAttribute('aria-hidden', String(!isOpen));
      openIcon.classList.toggle('hidden', isOpen);
      closeIcon.classList.toggle('hidden', !isOpen);
      setBodyLock(isOpen);
    };

    setMenuState(false);

    const handleToggleClick = () => {
      const isOpen = toggle.getAttribute('aria-expanded') === 'true';
      setMenuState(!isOpen);
    };

    toggle.addEventListener('click', handleToggleClick);

    header.querySelectorAll('[data-menu-close]').forEach((element) => {
      element.addEventListener('click', () => setMenuState(false));
    });

    const handleKeydown = (event) => {
      if (event.key === 'Escape') {
        setMenuState(false);
      }
    };

    window.addEventListener('keydown', handleKeydown);

    const handleResize = () => {
      if (window.innerWidth >= 768) {
        setMenuState(false);
      }
    };

    window.addEventListener('resize', handleResize, { passive: true });

    const handleBeforeUnload = () => setMenuState(false);
    window.addEventListener('beforeunload', handleBeforeUnload);

    const astroBeforeSwapEvent = 'astro:before-swap';
    const handleAstroBeforeSwap = () => setMenuState(false);
    document.addEventListener(astroBeforeSwapEvent, handleAstroBeforeSwap);

    const cleanup = () => {
      toggle.removeEventListener('click', handleToggleClick);
      window.removeEventListener('keydown', handleKeydown);
      window.removeEventListener('resize', handleResize);
      window.removeEventListener('beforeunload', handleBeforeUnload);
      document.removeEventListener(astroBeforeSwapEvent, handleAstroBeforeSwap);
      cleanupLocks();
    };

    window.addEventListener('pagehide', cleanup);
  })();
</script>
